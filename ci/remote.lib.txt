(@ def remote_build_variables(): -@)
BUILD_USER=${BUILD_USER:-build}
BUILD_PROJECT=${BUILD_PROJECT:-gemfire-dev}
BUILD_ZONE=${BUILD_ZONE:-us-central1-f}
BUILD_IDENTITY_DIR=${BUILD_IDENTITY_DIR:-$(pwd)/identity}
BUILD_INSTANCE_DIR=${BUILD_INSTANCE_DIR:-$(pwd)/instance}

if [ ! -d "${BUILD_IDENTITY_DIR}" ]; then
  echo "${BUILD_IDENTITY_DIR} not found."
  exit 1
fi

if [ ! -d "${BUILD_INSTANCE_DIR}" ]; then
  echo "${BUILD_INSTANCE_DIR} not found."
  exit 1
fi
(@- end @)

(@ def remote_shell(): -@)
(@=remote_build_variables() @)

SSH_OPTIONS=${SSH_OPTIONS:-"-o StrictHostKeyChecking=no -o PasswordAuthentication=no"}

ssh_key_file=${BUILD_IDENTITY_DIR}/${BUILD_USER}
if [ ! -r "${ssh_key_file}" ]; then
  echo "${ssh_key_file} not readable."
  exit 1
fi

instance_file=${BUILD_INSTANCE_DIR}/instance.json
if [ ! -r "${instance_file}" ]; then
  echo "${instance_file} not readable."
  exit 1
fi

external_ip=$(jq -r '.[0].networkInterfaces[0].accessConfigs[0].natIP' ${instance_file})

function remote_shell {
  ssh ${SSH_OPTIONS} -i ${ssh_key_file} ${BUILD_USER}@${external_ip} "$@"
}
(@- end @)

(@ def run_unit_tests(): -@)
remote_shell taskkill /t /f /im ctest.exe /im apache-geode_unittests.exe || true
remote_shell pkill ^ctest$ ^apache-geode_unittests$ || true
remote_shell cmake -E chdir build/cppcache/test ctest -C ${CMAKE_CONFIG} -j4 --timeout=500 --output-on-failure --rerun-failed
(@- end @)

(@ def run_integration_tests(): -@)
remote_shell taskkill /t /f /im ctest.exe /im cpp-integration-test.exe /im java.exe || true
remote_shell pkill ^ctest$ ^cpp-integration-test$ ^java$ || true
remote_shell cmake -E chdir build/cppcache/integration/test ctest -C ${CMAKE_CONFIG} -j4 --timeout=500 --output-on-failure --rerun-failed -E ^BasicIPv6Test
(@- end @)

(@ def run_legacy_integration_tests(): -@)
remote_shell taskkill /t /f /im ctest.exe /im test* /im java.exe || true
remote_shell pkill ^ctest$ ^test ^java$ || true
remote_shell cmake -E chdir build/cppcache/integration-test ctest -C ${CMAKE_CONFIG} -j4 --timeout=500 --output-on-failure --rerun-failed
(@- end @)
