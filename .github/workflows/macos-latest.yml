name: MacOS Latest CI

on: [push]

jobs:
  build-and-unit-test:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
    - name: cache geode
      uses: actions/cache@v2
      id: cache-geode-1120-mac
      with:
        path: ~/apache-geode
        key: apache-geode-1120-mac
    - name: install geode
      env:
        CACHE_HIT: ${{steps.cache-geode-1120-mac.outputs.cache-hit}}
        GEODE_VERSION: 1.12.0
      run: |
        if [[ "$CACHE_HIT" != 'true' ]]; then
          wget "https://www.apache.org/dyn/closer.cgi?action=download&filename=geode/${GEODE_VERSION}/apache-geode-${GEODE_VERSION}.tgz" --quiet -O - | tar xzf - && mv apache-geode-${GEODE_VERSION} ~/apache-geode
        fi
    - name: install doxygen
      run: brew install doxygen
    - name: mkdir build
      run: mkdir build
    - name: cmake configure
      run: export GEODE_HOME=~/apache-geode && cmake -Bbuild -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl
    - name: cmake build
      run: cmake --build build/ --target apache-geode_unittests -- -j4
    - name: unit tests
      run: build/cppcache/test/apache-geode_unittests

  old-integration-test:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
    - name: cache geode
      uses: actions/cache@v2
      id: cache-geode-1120-mac
      with:
        path: ~/apache-geode
        key: apache-geode-1120-mac
    - name: install geode
      env:
        CACHE_HIT: ${{steps.cache-geode-1120-mac.outputs.cache-hit}}
        GEODE_VERSION: 1.12.0
      run: |
        if [[ "$CACHE_HIT" != 'true' ]]; then
          wget "https://www.apache.org/dyn/closer.cgi?action=download&filename=geode/${GEODE_VERSION}/apache-geode-${GEODE_VERSION}.tgz" --quiet -O - | tar xzf - && mv apache-geode-${GEODE_VERSION} ~/apache-geode
        fi
    - name: install doxygen
      run: brew install doxygen
    - name: mkdir build
      run: mkdir build
    - name: cmake configure
      run: export GEODE_HOME=~/apache-geode && cmake -Bbuild -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl
    - name: cmake build
      run: cmake --build build/ --target javaobject -- -j4 && cmake --build build/ --target unit_test_callbacks -- -j4 && cmake --build build/ --target cppcache-integration-tests -- -j4
    - name: old integration tests
      run: cd build/cppcache/integration-test/ && ctest --timeout 500 -L STABLE -C Debug -j1

  new-integration-test:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
    - name: cache geode
      uses: actions/cache@v2
      id: cache-geode-1120-mac
      with:
        path: ~/apache-geode
        key: apache-geode-1120-mac
    - name: install geode
      env:
        CACHE_HIT: ${{steps.cache-geode-1120-mac.outputs.cache-hit}}
        GEODE_VERSION: 1.12.0
      run: |
        if [[ "$CACHE_HIT" != 'true' ]]; then
          wget "https://www.apache.org/dyn/closer.cgi?action=download&filename=geode/${GEODE_VERSION}/apache-geode-${GEODE_VERSION}.tgz" --quiet -O - | tar xzf - && mv apache-geode-${GEODE_VERSION} ~/apache-geode
        fi
    - name: install doxygen
      run: brew install doxygen
    - name: mkdir build
      run: mkdir build
    - name: cmake configure
      run: export GEODE_HOME=~/apache-geode && cmake -Bbuild -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl
    - name: cmake build
      run: cmake --build build/ --target cpp-integration-test -- -j4
    - name: new integration tests
      run: cd build/cppcache/integration/test/ && ctest -E BasicIPv6Test -j2
