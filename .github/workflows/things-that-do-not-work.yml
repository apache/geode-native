name: Things That Do Not Work CI

on: [push]

jobs:
  clangformat:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: cache geode
      uses: actions/cache@v2
      id: cache-geode-1120
      with:
        path: ~/apache-geode
        key: apache-geode-1120
      env:
        GEODE_VERSION: 1.12.0
    - name: install geode
      env:
        CACHE_HIT: ${{steps.cache-geode-1120.outputs.cache-hit}}
        GEODE_VERSION: 1.12.0
      run: |
        if [[ "$CACHE_HIT" != 'true' ]]; then
          wget "https://www.apache.org/dyn/closer.cgi?action=download&filename=geode/${GEODE_VERSION}/apache-geode-${GEODE_VERSION}.tgz" --quiet -O - | tar xzf - && mv apache-geode-${GEODE_VERSION} ~/apache-geode
        fi
    - name: install doxygen
      run: sudo apt-get update && sudo apt-get install -yq doxygen
    - name: mkdir build
      run: mkdir build
    - name: cmake configure
      run: export GEODE_HOME=~/apache-geode && cmake -Bbuild
    - name: cmake all-clangformat
      run: cmake --build build/ --target all-clangformat && git diff --exit-code

  build-and-test-ipv6-macos-latest:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
    - name: cache geode
      uses: actions/cache@v2
      id: cache-geode-1120-mac
      with:
        path: ~/apache-geode
        key: apache-geode-1120-mac
    - name: install geode
      env:
        CACHE_HIT: ${{steps.cache-geode-1120-mac.outputs.cache-hit}}
        GEODE_VERSION: 1.12.0
      run: |
        if [[ "$CACHE_HIT" != 'true' ]]; then
          wget "https://www.apache.org/dyn/closer.cgi?action=download&filename=geode/${GEODE_VERSION}/apache-geode-${GEODE_VERSION}.tgz" --quiet -O - | tar xzf - && mv apache-geode-${GEODE_VERSION} ~/apache-geode
        fi
    - name: install doxygen
      run: brew install doxygen
    - name: mkdir build
      run: mkdir build
    - name: cmake configure
      run: export GEODE_HOME=~/apache-geode && cmake -Bbuild -DWITH_IPV6=ON -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl
    - name: cmake build
      run: cmake --build build/ --target cpp-integration-test -- -j4
    - name: BasicIPv6Test
      run: cd build/cppcache/integration/test/ && ctest -R BasicIPv6Test -j1

  old-integration-test-windows:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
    steps:
    - uses: actions/checkout@v2
    - name: cache geode
      uses: actions/cache@v2
      id: cache-geode-1120-windows
      with:
        path: C:\apache-geode
        key: apache-geode-1120-windows
    - name: install geode
      env:
        CACHE_HIT: ${{steps.cache-geode-1120-windows.outputs.cache-hit}}
        GEODE_VERSION: 1.12.0
      run: |
        If ($env:CACHE_HIT -ne "true") {
          iwr "https://downloads.apache.org/geode/$env:GEODE_VERSION/apache-geode-$env:GEODE_VERSION.tgz" -OutFile apache-geode.tgz
          7z x apache-geode.tgz
          7z x apache-geode.tar
          mv apache-geode-$env:GEODE_VERSION C:\apache-geode
          rm apache*.t*
        }
    - name: install doxygen
      run: choco install doxygen.install -confirm
    - name: install nunit
      run: choco install nunit.install --version 2.6.4 -confirm
    - name: install openssl
      run: choco install openssl -confirm
    - name: mkdir build
      run: mkdir C:\build
    - name: cmake configure visual studio 2017
      if: ${{matrix.os == 'windows-2016'}}
      run: |
        $env:GEODE_HOME="C:\apache-geode"
        cmake -BC:\build -G "Visual Studio 15 2017 Win64" -Thost=x64
    - name: cmake configure visual studio 2019
      if: ${{matrix.os != 'windows-2016'}}
      run: |
        $env:GEODE_HOME="C:\apache-geode"
        cmake -BC:\build -G "Visual Studio 16 2019" -Thost=x64
    - name: cmake build
      run: |
        cmake --build C:\build --target javaobject -- /m
        cmake --build C:\build --target unit_test_callbacks -- /m
        cmake --build C:\build --target cppcache-integration-tests -- /m
    - name: old integration tests
      run: |
        cd C:\build\cppcache\integration-test\
        ctest --timeout 1000 -L STABLE -C Debug -j1

  new-integration-test-windows:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
    steps:
    - uses: actions/checkout@v2
    - name: cache geode
      uses: actions/cache@v2
      id: cache-geode-1120-windows
      with:
        path: C:\apache-geode
        key: apache-geode-1120-windows
    - name: install geode
      env:
        CACHE_HIT: ${{steps.cache-geode-1120-windows.outputs.cache-hit}}
        GEODE_VERSION: 1.12.0
      run: |
        If ($env:CACHE_HIT -ne "true") {
          iwr "https://downloads.apache.org/geode/$env:GEODE_VERSION/apache-geode-$env:GEODE_VERSION.tgz" -OutFile apache-geode.tgz
          7z x apache-geode.tgz
          7z x apache-geode.tar
          mv apache-geode-$env:GEODE_VERSION C:\apache-geode
          rm apache*.t*
        }
    - name: install doxygen
      run: choco install doxygen.install -confirm
    - name: install nunit
      run: choco install nunit.install --version 2.6.4 -confirm
    - name: install openssl
      run: choco install openssl -confirm
    - name: mkdir build
      run: mkdir C:\build
    - name: cmake configure visual studio 2017
      if: ${{matrix.os == 'windows-2016'}}
      run: |
        mkdir C:\geode-native
        mv * C:\geode-native\
        cd C:\geode-native
        $env:GEODE_HOME="C:\apache-geode"
        cmake -BC:\build -G "Visual Studio 15 2017 Win64" -Thost=x64
    - name: cmake configure visual studio 2019
      if: ${{matrix.os != 'windows-2016'}}
      run: |
        mkdir C:\geode-native
        mv * C:\geode-native\
        cd C:\geode-native
        $env:GEODE_HOME="C:\apache-geode"
        cmake -BC:\build -G "Visual Studio 16 2019" -Thost=x64
    - name: cmake build
      run: cmake --build C:\build --target cpp-integration-test -- /m
    - name: new integration tests
      run: |
        cd C:\build\cppcache\integration\test\
        ctest -E BasicIPv6Test -j2

  build-and-test-ipv6-windows:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-2016, windows-latest]
    steps:
    - uses: actions/checkout@v2
    - name: cache geode
      uses: actions/cache@v2
      id: cache-geode-1120-windows
      with:
        path: C:\apache-geode
        key: apache-geode-1120-windows
    - name: install geode
      env:
        CACHE_HIT: ${{steps.cache-geode-1120-windows.outputs.cache-hit}}
        GEODE_VERSION: 1.12.0
      run: |
        If ($env:CACHE_HIT -ne "true") {
          iwr "https://downloads.apache.org/geode/$env:GEODE_VERSION/apache-geode-$env:GEODE_VERSION.tgz" -OutFile apache-geode.tgz
          7z x apache-geode.tgz
          7z x apache-geode.tar
          mv apache-geode-$env:GEODE_VERSION C:\apache-geode
          rm apache*.t*
        }
    - name: install doxygen
      run: choco install doxygen.install -confirm
    - name: install nunit
      run: choco install nunit.install --version 2.6.4 -confirm
    - name: install openssl
      run: choco install openssl -confirm
    - name: mkdir build
      run: mkdir C:\build
    - name: cmake configure visual studio 2017
      if: ${{matrix.os == 'windows-2016'}}
      run: |
        mkdir C:\geode-native
        mv * C:\geode-native\
        cd C:\geode-native
        $env:GEODE_HOME="C:\apache-geode"
        cmake -BC:\build -G "Visual Studio 15 2017 Win64" -Thost=x64 -DWITH_IPV6=ON
    - name: cmake configure visual studio 2019
      if: ${{matrix.os != 'windows-2016'}}
      run: |
        mkdir C:\geode-native
        mv * C:\geode-native\
        cd C:\geode-native
        $env:GEODE_HOME="C:\apache-geode"
        cmake -BC:\build -G "Visual Studio 16 2019" -Thost=x64 -DWITH_IPV6=ON
    - name: cmake build
      run: cmake --build C:\build --target cpp-integration-test -- /m
    - name: BasicIPv6Test
      run: |
        cd C:\build\cppcache\integration\test\
        ctest -R BasicIPv6Test -j1
